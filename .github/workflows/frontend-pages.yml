# ============================================================
# ðŸš€ GitHub Actions: Deploy Angular Frontend to GitHub Pages
# ------------------------------------------------------------
# âœ… This workflow builds and deploys Angular app to GitHub Pages.
# âœ… Itâ€™s configured for a custom domain (https://learnforge.site).
# ðŸ’¡ If later we remove the custom domain and want to use the
#    GitHub Pages URL instead (like https://akhemani.github.io/terraform-aws-3tier-app-monorepo/),
#    will just uncomment the old build command and comment out the current one.
# ============================================================

name: Deploy Angular Frontend to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-pages.yml'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¥ Install dependencies
        working-directory: frontend
        run: npm ci

      # --------------------------------------------------------
      # ðŸ—ï¸ BUILD STEP
      # For custom domain (https://learnforge.site)
      # --------------------------------------------------------
      - name: ðŸ—ï¸ Build Angular app for Custom Domain
        working-directory: frontend
        run: npm run build -- --configuration production --base-href="/"

      # --------------------------------------------------------
      # ðŸ§© If we want to deploy to GitHub Pages without a custom domain
      # (https://akhemani.github.io/terraform-aws-3tier-app-monorepo/)
      # uncomment the below block and comment the above one
      # --------------------------------------------------------
      # - name: ðŸ—ï¸ Build Angular app for GitHub Pages
      #   working-directory: frontend
      #   run: npm run build -- --configuration production --base-href="/${{ github.event.repository.name }}/"

      # --------------------------------------------------------
      # ðŸªª Add CNAME file for custom domain mapping
      # --------------------------------------------------------
      - name: ðŸªª Add CNAME file
        run: echo "learnforge.site" > frontend/dist/frontend/browser/CNAME

      - name: ðŸ“¤ Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/dist/frontend/browser

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
